<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="format-detection" content="telephone=no" />
		<title>添加地址</title>
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/new_address.css" rel="stylesheet">
		<link rel="stylesheet" href="css/LArea.css">
		<link href="css/new_address.css" rel="stylesheet">
		<script src="js/html5shiv.min.js"></script>
	</head>
	<style>
		html,
		body {
			background: #f2f2f2;
		}
	</style>

	<body>
		<div class="address_area">
			<div class="address_list">
				<span class="address_list_text">收货人:</span>
				<input class="address_list_input" type="text" id="content_name" />
			</div>
			<div class="address_list">
				<span class="address_list_text">联系方式:</span>
				<input class="address_list_input" type="text" id='content_tel' />
			</div>
			<div class="address_list">
				<span>联系方式:</span>
				<div class="content-block">
					<input class="city_input" id="demo1" type="text" readonly="" placeholder="城市选择特效" value="广东省,深圳市,南山区" />
					<input id="value1" type="hidden" value="20,234,504" />
				</div>
			</div>
			<div class="address_list">
				<span class="address_list_text">详细地址:</span>
				<input class="address_list_input" placeholder="街道，地址等" type="text" id="content_ver" />
			</div>
			<!--<div class="content-block">
				<input id="demo2" type="text" readonly="" placeholder="城市选择特效" />
				<input id="value2" type="hidden" />
			</div>-->

		</div>

		<button class="btn_ok" id="btn_ok" onclick="btnSure()" style="display: none;">保存</button>
		<button class="btn_no" id="btn_no" onclick="btnSure()">保存</button>
		<script src="js/jquery-1.11.3.min.js "></script>
		<script src="../js/mui.min.js"></script>
		<script src="js/bootstrap.js "></script>
		<script src="js/LAreaData1.js"></script>
		<script src="js/LAreaData2.js"></script>
		<script src="js/LArea.js"></script>
		<script src="../js/common/bdapp.js"></script>
		<script src="../js/config/web_config.js"></script>
		<script>
			//各个屏幕大小适配
			(function(doc, win) {
				var docEl = doc.documentElement,
					resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
					recalc = function() {
						var clientWidth = docEl.clientWidth;
						if(!clientWidth) return;
						docEl.style.fontSize = 100 * (clientWidth / 375) + 'px';
					};

				if(!doc.addEventListener) return;
				win.addEventListener(resizeEvt, recalc, false);
				doc.addEventListener('DOMContentLoaded', recalc, false);
			})(document, window);
		</script>
		<script>
			var area1 = new LArea();
			area1.init({
				'trigger': '#demo1', //触发选择控件的文本框，同时选择完毕后name属性输出到该位置
				'valueTo': '#value1', //选择完毕后id属性输出到该位置
				'keys': {
					id: 'id',
					name: 'name'
				}, //绑定数据源相关字段 id对应valueTo的value属性输出 name对应trigger的value属性输出
				'type': 1, //数据源类型
				'data': LAreaData //数据源
			});
			area1.value = [1, 13, 3]; //控制初始位置，注意：该方法并不会影响到input的value
			//			var area2 = new LArea();
			//			area2.init({
			//				'trigger': '#demo2',
			//				'valueTo': '#value2',
			//				'keys': {
			//					id: 'value',
			//					name: 'text'
			//				},
			//				'type': 2,
			//				'data': [provs_data, citys_data, dists_data]
			//			});
		</script>
		<script>
			var content_name_status = false;
			var content_tel_status = false;
			var content_ver_status = false;
			var SaveVipAddress_url = test_url + '/api/SmallProgram/SaveVipAddress';
			var GetMemberInfo_url = test_url + '/api/aliwx/GetMemberInfo';
			var province;
			var city
			var area;
			var street;
			var consignee;
			var phone;
			var member_id;
			var token = GetQueryString('token')
			var open_id = GetQueryString('open_id')
			var store_id = GetQueryString('store_id')
			var orderid = GetQueryString('orderid')
			var vip_id = GetQueryString('vip_id')

			var GetMemberInfo_url = test_url + '/api/aliwx/GetMemberInfo'; //BDapp进入
			var GetMemberInfoExtend_url = test_url + '/api/aliwx/GetMemberInfo_Extend'; //微信进入
			var source_from = GetQueryString('source_from')
			if(source_from == 'app') { //如果是app进入
				$('.btn_bottom').hide()
				GetMemberInfo(GetMemberInfo_url, token);
			} else {
				GetMemberInfo(GetMemberInfoExtend_url, token);
			}

			$('input').blur(function() {
				if($(this).is('#content_tel')) {
					if(!(/^1[34578]\d{9}$/.test(this.value))) {
						var errorMsg = '手机号码错误';
						Alert(errorMsg);
						content_tel_status = false;
					} else {
						//						Alert('手机号输入正确');
						content_tel_status = true;
					}
				} else if($(this).is('#content_name')) {
					if(this.value == "") {
						var errorMsg = '收货人不能为空';
						Alert(errorMsg);
						content_name_status = false;
					} else {
						//						Alert('姓名输入正确');
						content_name_status = true;
					}
				} else if($(this).is('#content_ver')) {
					if(this.value == "") {
						var errorMsg = '详细地址不能为空';
						Alert(errorMsg);
						content_ver_status = false;
					} else {
						content_ver_status = true;
					}
				}
				ifBtn()
			});

			function GetMemberInfo(GetMemberInfo_url, token) {
				mui.ajax(GetMemberInfo_url, {
					data: {

					},
					dataType: 'json', //服务器返回json格式数据
					type: 'get', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					async: false,
					headers: {
						'Content-Type': 'application/json',
						'token': token
					},
					success: function(data) {
						//服务器返回响应，根据响应结果，分析是否登录成功；
						console.log('需要的token：' + token);
						console.log(data);
						var MemberInfo = data.Data.MemberInfo;
						member_id = MemberInfo.id;

					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log('需要的token：' + token);
						console.log(type);
					}
				});
			}


			function ifBtn() {
				if(content_name_status == true && content_tel_status == true && content_ver_status == true) {
					$('#btn_ok').show()
					$('#btn_no').hide()
				} else {
					$('#btn_ok').hide()
					$('#btn_no').show()
				}
			}

			function btnSure() {

				var area_array = $('#demo1').val();
				area_array = area_array.split(',');
				console.log(area_array);
				province = area_array[0];
				city = area_array[1];
				area = area_array[2];
				street = $('#content_ver').val();
				consignee = $('#content_name').val();
				phone = $('#content_tel').val();
				SaveVipAddress(SaveVipAddress_url, province, city, area, street, consignee, phone, open_id, token, store_id, orderid, vip_id, member_id)
			}

			function SaveVipAddress(SaveVipAddress_url, province, city, area, street, consignee, phone, open_id, token, store_id, orderid, vip_id, member_id) {
				mui.ajax(SaveVipAddress_url, {
					data: {
						province: province,
						city: city,
						area: area,
						street: street,
						consignee: consignee,
						phone: phone,
						defaultAddress: 1,
						union_id: open_id,
						member_id: member_id
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					headers: {
						'Content-Type': 'application/json',
						'token': token
					},
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						//服务器返回响应，根据响应结果，分析是否登录成功；
						console.log(data);
						//						alert('SaveVipAddress开始')
						//						alert(JSON.stringify(data))
						if(data.Data.IsError == false) {
							Alert('新建地址成功')
							window.location.href = 'address.html?token=' + token + '&open_id=' + open_id + '&store_id=' + store_id + '&orderid=' + orderid + '&vip_id=' + vip_id+'&source_from='+source_from;
						}

					},

					error: function(xhr, type, errorThrown) {
						//异常处理；
						//						alert('SaveVipAddress接口出错')
						//						alert(errorThrown)
					}
				});
			}
		</script>

	</body>

</html>